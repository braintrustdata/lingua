name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Download OpenAPI specs
      run: |
        mkdir -p specs/openai specs/anthropic
        curl -s "https://app.stainless.com/api/spec/documented/openai/openapi.documented.yml" -o specs/openai/openapi.yml
        curl -s "https://raw.githubusercontent.com/laszukdawid/anthropic-openapi-spec/main/hosted_spec.json" -o specs/anthropic/openapi.json
    
    - name: Run clippy and format
      run: |
        cargo clippy --all-targets --all-features --fix --allow-dirty -- -D warnings
        cargo fmt --all
    
    - name: Check for uncommitted changes
      run: |
        if ! git diff --quiet; then
          echo "Code formatting or clippy fixes needed. Run 'cargo clippy --fix && cargo fmt' locally."
          git diff
          exit 1
        fi
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose