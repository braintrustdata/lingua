#!/bin/bash

# Pre-commit hook for Lingua project
# Runs formatting and linting for Rust, Go, and TypeScript

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a Rust project
if [ ! -f "Cargo.toml" ]; then
    echo "âŒ No Cargo.toml found, skipping Rust checks"
    exit 0
fi

# Run cargo fmt to format all files
echo "ğŸ“ Running cargo fmt..."
cargo fmt --all

# Check for Go files and run Go checks
if [ -d "bindings/golang" ] && [ -f "bindings/golang/go.mod" ]; then
    echo "ğŸ“ Running Go checks..."

    cd bindings/golang

    # Ensure the jsonv2 experiment is enabled for Go tooling unless already set
    export GOEXPERIMENT="${GOEXPERIMENT:-jsonv2}"

    # Check if Go is installed
    if ! command -v go &> /dev/null; then
        echo "âš ï¸  Go not installed, skipping Go checks"
        cd ../..
    else
        # Run go fmt
        echo "ğŸ” Running go fmt..."
        go fmt ./...

        # Run go vet
        echo "ğŸ” Running go vet..."
        if ! go vet ./...; then
            echo "âŒ go vet found issues. Please fix before committing."
            cd ../..
            exit 1
        fi

        # Run golangci-lint if available (recommended but optional)
        if command -v golangci-lint &> /dev/null; then
            echo "ğŸ” Running golangci-lint..."
            if ! golangci-lint run ./...; then
                echo "âŒ golangci-lint found issues. Please fix before committing."
                cd ../..
                exit 1
            fi
        else
            echo "â„¹ï¸  golangci-lint not installed, skipping (install with: brew install golangci-lint)"
        fi

        cd ../..
    fi
fi

# Check for TypeScript files and run linting/formatting
if [ -f "payloads/package.json" ]; then
    echo "ğŸ“ Running TypeScript checks..."

    # Change to payloads directory
    cd payloads

    # Check if dependencies are installed
    if [ ! -d "node_modules" ]; then
        echo "âŒ Dependencies not installed in payloads/"
        echo "ğŸ’¡ Please run the setup script first:"
        echo "   ./scripts/setup.sh"
        echo ""
        echo "   Or install manually:"
        echo "   cd payloads && pnpm install && cd .."
        exit 1
    fi

    # Run ESLint
    echo "ğŸ” Running ESLint..."
    if ! npm run lint; then
        echo "âŒ ESLint found issues. Run 'npm run lint:fix' to fix automatically or fix manually."
        exit 1
    fi

    # Run Prettier check
    echo "ğŸ¨ Checking code formatting..."
    if ! npm run format:check; then
        echo "âŒ Code formatting issues found."
        echo "ğŸ’¡ Running Prettier to fix formatting..."
        npm run format
        cd ..
        echo "âŒ Files were formatted by Prettier."
        echo "ğŸ’¡ Please re-add the formatted files and commit again:"
        echo "   git add -A && git commit"
        exit 1
    fi

    # Run TypeScript type checking
    echo "ğŸ” Running TypeScript type check..."
    if ! npm run typecheck; then
        echo "âŒ TypeScript type errors found. Please fix before committing."
        exit 1
    fi

    cd ..
fi

# Check if any files were changed by formatting
if ! git diff --quiet; then
    echo "âŒ Files were formatted."
    echo "ğŸ’¡ Please re-add the formatted files and commit again:"
    echo "   git add -A && git commit"
    exit 1
fi

echo "âœ… All checks passed!"