#!/bin/bash

# Pre-commit hook for Lingua project
# Runs cargo fmt for Rust and ESLint/Prettier for TypeScript

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a Rust project
if [ ! -f "Cargo.toml" ]; then
    echo "âŒ No Cargo.toml found, skipping Rust checks"
    exit 0
fi

# Run cargo fmt to format all files
echo "ğŸ“ Running cargo fmt..."
cargo fmt --all

# Check for TypeScript files and run linting/formatting
if [ -f "payloads/package.json" ]; then
    echo "ğŸ“ Running TypeScript checks..."

    # Change to payloads directory
    cd payloads

    # Check if dependencies are installed
    if [ ! -d "node_modules" ]; then
        echo "âŒ Dependencies not installed in payloads/"
        echo "ğŸ’¡ Please run the setup script first:"
        echo "   ./scripts/setup.sh"
        echo ""
        echo "   Or install manually:"
        echo "   cd payloads && pnpm install && cd .."
        exit 1
    fi

    # Run ESLint
    echo "ğŸ” Running ESLint..."
    if ! npm run lint; then
        echo "âŒ ESLint found issues. Run 'npm run lint:fix' to fix automatically or fix manually."
        exit 1
    fi

    # Run Prettier check
    echo "ğŸ¨ Checking code formatting..."
    if ! npm run format:check; then
        echo "âŒ Code formatting issues found."
        echo "ğŸ’¡ Running Prettier to fix formatting..."
        npm run format
        cd ..
        echo "âŒ Files were formatted by Prettier."
        echo "ğŸ’¡ Please re-add the formatted files and commit again:"
        echo "   git add -A && git commit"
        exit 1
    fi

    # Run TypeScript type checking
    echo "ğŸ” Running TypeScript type check..."
    if ! npm run typecheck; then
        echo "âŒ TypeScript type errors found. Please fix before committing."
        exit 1
    fi

    cd ..
fi

# Check if any files were changed by formatting
if ! git diff --quiet; then
    echo "âŒ Files were formatted."
    echo "ğŸ’¡ Please re-add the formatted files and commit again:"
    echo "   git add -A && git commit"
    exit 1
fi

echo "âœ… All checks passed!"