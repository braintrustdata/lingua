#!/bin/bash

# Pre-commit hook for LLMIR project
# Runs cargo fmt for Rust and ESLint/Prettier for TypeScript

set -e

echo "🔍 Running pre-commit checks..."

# Check if we're in a Rust project
if [ ! -f "Cargo.toml" ]; then
    echo "❌ No Cargo.toml found, skipping Rust checks"
    exit 0
fi

# Run cargo fmt to format all files
echo "📝 Running cargo fmt..."
cargo fmt --all

# Check for TypeScript files and run linting/formatting
if [ -f "payloads/package.json" ]; then
    echo "📝 Running TypeScript checks..."

    # Change to payloads directory
    cd payloads

    # Run ESLint
    echo "🔍 Running ESLint..."
    if ! npm run lint; then
        echo "❌ ESLint found issues. Run 'npm run lint:fix' to fix automatically or fix manually."
        exit 1
    fi

    # Run Prettier check
    echo "🎨 Checking code formatting..."
    if ! npm run format:check; then
        echo "❌ Code formatting issues found."
        echo "💡 Running Prettier to fix formatting..."
        npm run format
        cd ..
        echo "❌ Files were formatted by Prettier."
        echo "💡 Please re-add the formatted files and commit again:"
        echo "   git add -A && git commit"
        exit 1
    fi

    # Run TypeScript type checking
    echo "🔍 Running TypeScript type check..."
    if ! npm run typecheck; then
        echo "❌ TypeScript type errors found. Please fix before committing."
        exit 1
    fi

    cd ..
fi

# Check if any files were changed by formatting
if ! git diff --quiet; then
    echo "❌ Files were formatted."
    echo "💡 Please re-add the formatted files and commit again:"
    echo "   git add -A && git commit"
    exit 1
fi

echo "✅ All checks passed!"